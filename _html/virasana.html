

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="pt-BR" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="pt-BR" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>VIRASANA &mdash; AJNA 0.1a documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="PADMA" href="padma.html" />
    <link rel="prev" title="BHADRASANA" href="bhadrasana.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> AJNA
          

          
          </a>

          
            
            
              <div class="version">
                0.1a
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tópicos:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="manuais.html">Manuais de Usuário</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="codigofonte.html">Documentação do código-fonte</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ajna_commons.html">COMMONS</a></li>
<li class="toctree-l2"><a class="reference internal" href="bhadrasana.html">BHADRASANA</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">VIRASANA</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#module-virasana.virasana.views">Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="#integracao">Integracao</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#module-virasana.virasana.integracao">__init__</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-virasana.virasana.integracao.xml">XML</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-virasana.virasana.integracao.carga">Carga</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#workers">Workers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#module-virasana.virasana.workers.dir_monitor">dir_monitor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-virasana.virasana.workers.tasks">tasks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="padma.html">PADMA</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="UserStories.html">Histórias de Usuário</a></li>
<li class="toctree-l1"><a class="reference internal" href="Arquitetura.html">Módulos do Sistema</a></li>
<li class="toctree-l1"><a class="reference internal" href="Arquitetura.html#arquitetura-do-sistema">Arquitetura do Sistema</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">AJNA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="codigofonte.html">Documentação do código-fonte</a> &raquo;</li>
        
      <li>VIRASANA</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/virasana.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="contents topic" id="topicos">
<p class="topic-title first">Tópicos</p>
<ul class="simple">
<li><a class="reference internal" href="#virasana" id="id1">VIRASANA</a><ul>
<li><a class="reference internal" href="#module-virasana.virasana.views" id="id2">Interface</a></li>
<li><a class="reference internal" href="#integracao" id="id3">Integracao</a><ul>
<li><a class="reference internal" href="#module-virasana.virasana.integracao" id="id4">__init__</a></li>
<li><a class="reference internal" href="#module-virasana.virasana.integracao.xml" id="id5">XML</a></li>
<li><a class="reference internal" href="#module-virasana.virasana.integracao.carga" id="id6">Carga</a></li>
</ul>
</li>
<li><a class="reference internal" href="#workers" id="id7">Workers</a><ul>
<li><a class="reference internal" href="#module-virasana.virasana.workers.dir_monitor" id="id8">dir_monitor</a></li>
<li><a class="reference internal" href="#module-virasana.virasana.workers.tasks" id="id9">tasks</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p><a class="reference external" href="index.html">Voltar ao Indice</a></p>
<div class="section" id="virasana">
<h1><a class="toc-backref" href="#id1">VIRASANA</a><a class="headerlink" href="#virasana" title="Permalink to this headline">¶</a></h1>
<p>Virasana é o módulo que recebe as imagens dos AVATARES, permite gerenciar e consultar as
imagens, e busca completar as imagens com metadados vindos dos módulos BHADRASANA e PADMA</p>
<div class="section" id="module-virasana.virasana.views">
<span id="interface"></span><h2><a class="toc-backref" href="#id2">Interface</a><a class="headerlink" href="#module-virasana.virasana.views" title="Permalink to this headline">¶</a></h2>
<p>Coleção de views da interface web do módulo virasana.</p>
<dl class="class">
<dt id="virasana.virasana.views.FilesForm">
<em class="property">class </em><code class="descclassname">virasana.virasana.views.</code><code class="descname">FilesForm</code><span class="sig-paren">(</span><em>formdata=&lt;object object&gt;</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#FilesForm"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.FilesForm" title="Permalink to this definition">¶</a></dt>
<dd><p>Valida pesquisa de arquivos.</p>
<p>Usa wtforms para facilitar a validação dos campos de pesquisa da tela
search_files.html</p>
</dd></dl>

<dl class="class">
<dt id="virasana.virasana.views.StatsForm">
<em class="property">class </em><code class="descclassname">virasana.virasana.views.</code><code class="descname">StatsForm</code><span class="sig-paren">(</span><em>formdata=&lt;object object&gt;</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#StatsForm"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.StatsForm" title="Permalink to this definition">¶</a></dt>
<dd><p>Valida datas da tela de estatísticas.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.allowed_file">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">allowed_file</code><span class="sig-paren">(</span><em>filename</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#allowed_file"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.allowed_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Checa extensões permitidas.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.api_upload">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">api_upload</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#api_upload"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.api_upload" title="Permalink to this definition">¶</a></dt>
<dd><p>Função para upload via API de um arquivo BSON.</p>
<p>Coloca o arquivo numa queue do Banco de Dados Redis
e inicia uma task Celery. O resultado do processamento efetivo do
arquivo pode ser acompanhado na view
py:func:<cite>task_progress</cite></p>
<dl class="docutils">
<dt>Args:</dt>
<dd>file: arquivo BSON gerado pelo AJNA e enviado via HTTP POST</dd>
<dt>Returns:</dt>
<dd>json[‘success’]: True ou False
json[‘taskid’]: ID da task do celery a ser monitorada</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.file">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">file</code><span class="sig-paren">(</span><em>_id=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#file"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.file" title="Permalink to this definition">¶</a></dt>
<dd><p>Tela para exibição de um ‘arquivo’ do GridFS.</p>
<p>Exibe o arquivo e os metadados associados a ele.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.files">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">files</code><span class="sig-paren">(</span><em>page=1</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#files"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.files" title="Permalink to this definition">¶</a></dt>
<dd><p>Recebe um filtro, aplica no GridFS, retorna a lista de arquivos.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.image">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">image</code><span class="sig-paren">(</span><em>_id</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#image"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.image" title="Permalink to this definition">¶</a></dt>
<dd><p>Serializa a imagem do banco para stream HTTP.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.index">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">index</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#index"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.index" title="Permalink to this definition">¶</a></dt>
<dd><p>View retorna index.html ou login se não autenticado.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.list_files">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">list_files</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#list_files"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.list_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Lista arquivos no banco MongoDB.</p>
<p>Lista 10 arquivos mais recentes no banco MongoDB,
por uploadDate mais recente.
Se houver upload em andamento, informa.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.mynavbar">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">mynavbar</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#mynavbar"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.mynavbar" title="Permalink to this definition">¶</a></dt>
<dd><p>Menu da aplicação.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.padma_proxy">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">padma_proxy</code><span class="sig-paren">(</span><em>image_id</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#padma_proxy"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.padma_proxy" title="Permalink to this definition">¶</a></dt>
<dd><p>Teste. Envia uma imagem para padma teste e repassa retorno.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.plot">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">plot</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#plot"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.plot" title="Permalink to this definition">¶</a></dt>
<dd><p>Renderiza gráfico no matplot e serializa via HTTP/HTML.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.stats">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">stats</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#stats"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.stats" title="Permalink to this definition">¶</a></dt>
<dd><p>Permite consulta as estatísticas do GridFS e integrações.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.task_progress">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">task_progress</code><span class="sig-paren">(</span><em>taskid</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#task_progress"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.task_progress" title="Permalink to this definition">¶</a></dt>
<dd><p>Retorna um json do progresso da celery task.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.views.upload_bson">
<code class="descclassname">virasana.virasana.views.</code><code class="descname">upload_bson</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/views.html#upload_bson"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.views.upload_bson" title="Permalink to this definition">¶</a></dt>
<dd><p>Função simplificada para upload do arquivo de uma extração.</p>
<p>Ver API/Upload BSON</p>
</dd></dl>

</div>
<div class="section" id="integracao">
<h2><a class="toc-backref" href="#id3">Integracao</a><a class="headerlink" href="#integracao" title="Permalink to this headline">¶</a></h2>
<p>Neste diretório ficam os diversos scripts para integração entre as imagens e
as fontes de dados. Cada fonte de dados deve ter um módulo definido.</p>
<div class="section" id="module-virasana.virasana.integracao">
<span id="init"></span><h3><a class="toc-backref" href="#id4">__init__</a><a class="headerlink" href="#module-virasana.virasana.integracao" title="Permalink to this headline">¶</a></h3>
<p>Funções padrão para exploração do GridFS.</p>
<p>Como repositório de informações do Banco de Dados, facilitando a documentação
e o desenvolvimento.</p>
<p>Assim, neste arquivo e nos demais deste módulo pode-se conferir como está
sendo estruturado o Banco de Dados final, que nada mais é do que a integração
de diversas fontes de dados, cada uma com seu módulo neste pacote. Pode-se
também conferir os campos chave para os quais estão sendo criados índices,
conferir as “chaves primária e estrangeira”, as datas, categorias, etc.</p>
<p>Além disso, podem ser criadas e mantidas aqui funções que dêem estatíticas
sobre a base para informar os usuários.</p>
<dl class="function">
<dt id="virasana.virasana.integracao.create_indexes">
<code class="descclassname">virasana.virasana.integracao.</code><code class="descname">create_indexes</code><span class="sig-paren">(</span><em>db</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao.html#create_indexes"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.create_indexes" title="Permalink to this definition">¶</a></dt>
<dd><p>Cria índices necessários no GridFS.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.datas_bases">
<code class="descclassname">virasana.virasana.integracao.</code><code class="descname">datas_bases</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao.html#datas_bases"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.datas_bases" title="Permalink to this definition">¶</a></dt>
<dd><p>Retorna nomes dos campos que possuem as datas de referência.</p>
<p>Para cada integração, consulta se há data de referência e retorna</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.gridfs_count">
<code class="descclassname">virasana.virasana.integracao.</code><code class="descname">gridfs_count</code><span class="sig-paren">(</span><em>db</em>, <em>filtro={}</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao.html#gridfs_count"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.gridfs_count" title="Permalink to this definition">¶</a></dt>
<dd><p>Aplica filtro, retorna contagem.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.peso_container_balanca">
<code class="descclassname">virasana.virasana.integracao.</code><code class="descname">peso_container_balanca</code><span class="sig-paren">(</span><em>db</em>, <em>numero: list</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao.html#peso_container_balanca"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.peso_container_balanca" title="Permalink to this definition">¶</a></dt>
<dd><p>Procedimento necessário para apurar o peso pesado do contêiner.</p>
<p>Procedimento necessário para apurar o peso do contêiner tendo em vista
as informações importadas dos sistemas de pesagem dos Recintos Aduaneiros.</p>
<dl class="docutils">
<dt>Args:</dt>
<dd>db: conexão ao MongoDB GridFS
numero: lista com os números de</dd>
<dt>Returns:</dt>
<dd>dict[numero] = peso</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.peso_container_documento">
<code class="descclassname">virasana.virasana.integracao.</code><code class="descname">peso_container_documento</code><span class="sig-paren">(</span><em>db</em>, <em>numeros: list</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao.html#peso_container_documento"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.peso_container_documento" title="Permalink to this definition">¶</a></dt>
<dd><p>Procedimento necessário para apurar o peso do contêiner.</p>
<p>Procedimento necessário para apurar o peso do contêiner tendo em vista
as informações importadas do CARGA.</p>
<dl class="docutils">
<dt>Args:</dt>
<dd>db: conexão ao MongoDB GridFS
numero: lista com os números de contêiner</dd>
<dt>Returns:</dt>
<dd>dict[numero] = peso</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.plot_pie">
<code class="descclassname">virasana.virasana.integracao.</code><code class="descname">plot_pie</code><span class="sig-paren">(</span><em>values</em>, <em>labels</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao.html#plot_pie"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.plot_pie" title="Permalink to this definition">¶</a></dt>
<dd><p>Gera gráfico de pizza.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.stats_por">
<code class="descclassname">virasana.virasana.integracao.</code><code class="descname">stats_por</code><span class="sig-paren">(</span><em>db</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao.html#stats_por"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.stats_por" title="Permalink to this definition">¶</a></dt>
<dd><p>soon.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.stats_resumo_imagens">
<code class="descclassname">virasana.virasana.integracao.</code><code class="descname">stats_resumo_imagens</code><span class="sig-paren">(</span><em>db</em>, <em>datainicio=None</em>, <em>datafim=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao.html#stats_resumo_imagens"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.stats_resumo_imagens" title="Permalink to this definition">¶</a></dt>
<dd><p>Números gerais do Banco de Dados e suas integrações.</p>
<p>Estatísticas gerais sobre as imagens</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.volume_container">
<code class="descclassname">virasana.virasana.integracao.</code><code class="descname">volume_container</code><span class="sig-paren">(</span><em>db</em>, <em>numeros: list</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao.html#volume_container"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.volume_container" title="Permalink to this definition">¶</a></dt>
<dd><p>Procedimento necessário para apurar o volume do contêiner.</p>
<p>Procedimento necessário para apurar o volume do contêiner tendo em vista
as informações importadas do CARGA.</p>
<dl class="docutils">
<dt>Args:</dt>
<dd>db: conexão ao MongoDB GridFS
numero: lista com os números de contêiner</dd>
<dt>Returns:</dt>
<dd>dict[numero] = volume</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-virasana.virasana.integracao.xml">
<span id="xml"></span><h3><a class="toc-backref" href="#id5">XML</a><a class="headerlink" href="#module-virasana.virasana.integracao.xml" title="Permalink to this headline">¶</a></h3>
<p>Funções para leitura e tratamento arquivos XML criados pelos escâneres.</p>
<dl class="function">
<dt id="virasana.virasana.integracao.xml.create_indexes">
<code class="descclassname">virasana.virasana.integracao.xml.</code><code class="descname">create_indexes</code><span class="sig-paren">(</span><em>db</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao/xml.html#create_indexes"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.xml.create_indexes" title="Permalink to this definition">¶</a></dt>
<dd><p>Utilitário. Cria índices relacionados à integração.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.xml.dados_xml_grava_fsfiles">
<code class="descclassname">virasana.virasana.integracao.xml.</code><code class="descname">dados_xml_grava_fsfiles</code><span class="sig-paren">(</span><em>db</em>, <em>batch_size=5000</em>, <em>data_inicio=datetime.datetime(1900</em>, <em>1</em>, <em>1</em>, <em>0</em>, <em>0)</em>, <em>update=True</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao/xml.html#dados_xml_grava_fsfiles"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.xml.dados_xml_grava_fsfiles" title="Permalink to this definition">¶</a></dt>
<dd><p>Busca por registros no GridFS sem info do XML.</p>
<p>Busca por registros no fs.files (GridFS - imagens) que não tenham metadata
importada do arquivo XML. Itera estes registros, consultando a
xml_todict para ver se retorna informações do XML. Encontrando
estas informações, grava no campo metadata.xml do fs.files</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><p class="first">db: connection to mongo with database setted</p>
<p>batch_size: número de registros a consultar/atualizar por chamada</p>
<p>data_inicio: filtra por data de escaneamento maior que a informada</p>
<dl class="last docutils">
<dt>update: Caso seja setado como False, apenas faz consulta, sem</dt>
<dd>atualizar metadata da collection fs.files</dd>
</dl>
</dd>
<dt>Returns:</dt>
<dd>Número de registros encontrados</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.xml.xml_todict">
<code class="descclassname">virasana.virasana.integracao.xml.</code><code class="descname">xml_todict</code><span class="sig-paren">(</span><em>xml</em><span class="sig-paren">)</span> &#x2192; dict<a class="reference internal" href="_modules/virasana/virasana/integracao/xml.html#xml_todict"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.xml.xml_todict" title="Permalink to this definition">¶</a></dt>
<dd><p>Recebe um XML string stream, retorna um dict com campos do XML.</p>
<p>Lê o XML que acompanha as imagens no formato do Escâner da ALFSTS,
retorna dict(s) com os dados considerados mais importantes e resumos
(ex.: número do(s) cc(s), datas, etc) - configurar na var. fields</p>
<dl class="docutils">
<dt>Args:</dt>
<dd>xml: string de texto na memória com o conteúdo do arquivo XML</dd>
<dt>Returns:</dt>
<dd>Dicionário com as tags selecionadas. A tag container é uma lista
(imagens de cc de 20’ podem conter dois contêineres escaneados)</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-virasana.virasana.integracao.carga">
<span id="carga"></span><h3><a class="toc-backref" href="#id6">Carga</a><a class="headerlink" href="#module-virasana.virasana.integracao.carga" title="Permalink to this headline">¶</a></h3>
<p>Funçãoes para importar os dados do formulário CARGA do Bhadrasana.</p>
<dl class="function">
<dt id="virasana.virasana.integracao.carga.busca_atracacao_data">
<code class="descclassname">virasana.virasana.integracao.carga.</code><code class="descname">busca_atracacao_data</code><span class="sig-paren">(</span><em>atracacoes: list</em>, <em>scan_datetime: datetime.datetime</em>, <em>days=4</em><span class="sig-paren">)</span> &#x2192; int<a class="reference internal" href="_modules/virasana/virasana/integracao/carga.html#busca_atracacao_data"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.carga.busca_atracacao_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Pega da lista de atracações, a atracação com a data mais próxima.</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><p class="first">atracacoes: lista de dict contendo os registros das atracacoes</p>
<p>data: data buscada</p>
<p class="last">days: “threshold”  máxima diferença entre as datas - default definido
no começo da função</p>
</dd>
<dt>Returns:</dt>
<dd>Índice da atracação, None se atracação não existe ou não está no
intervalo threshold</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.carga.busca_info_container">
<code class="descclassname">virasana.virasana.integracao.carga.</code><code class="descname">busca_info_container</code><span class="sig-paren">(</span><em>db</em>, <em>numero: str</em>, <em>data_escaneamento: datetime.datetime</em>, <em>days=4</em><span class="sig-paren">)</span> &#x2192; dict<a class="reference internal" href="_modules/virasana/virasana/integracao/carga.html#busca_info_container"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.carga.busca_info_container" title="Permalink to this definition">¶</a></dt>
<dd><p>Busca heurística na base CARGA MongoDB de dados sobre o Contêiner.</p>
<p>A busca é baseada na data de escaneamento. O parâmetro dias é um
“threshold” (diferença aceita entre a data de atracação e escaneamento),
por padrão, é de 4 dias.</p>
<p>Dentro destes 4 dias, será considerado o CE/Manifesto/Escala com menor
diferença de data como o pertencente a este contêiner.
Note-se que o resultado não é garantido, podendo trazer um CE incorreto.</p>
<p>As informações são imperfeitas e não há como garantir trazer o CE correto,
mas espera-se um acerto próximo de 100%, já que a frequência de cada
contêiner em cada porto tem um intervalo típico de semanas e até meses,
sendo extremamente incomum um contêiner ter duas “viagens” no mesmo
porto em menos de 4 dias +/-.</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><p class="first">numero: número completo do contêiner</p>
<p>data_escaneamento: data e hora do escaneamento, conforme
arquivo XML original do escâner</p>
<p class="last">days: número de dias a aceitar de diferença</p>
</dd>
<dt>Returns:</dt>
<dd>json_dict: Dicionário com campos e valores de informações da base
CARGA VAZIO se não encontrar nada dentro do threshold
(Caso não encontre atracacao para o Contêiner no prazo, o dado ?ainda?
não existe ou não foi importado ou há um erro)!</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.carga.create_indexes">
<code class="descclassname">virasana.virasana.integracao.carga.</code><code class="descname">create_indexes</code><span class="sig-paren">(</span><em>db</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao/carga.html#create_indexes"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.carga.create_indexes" title="Permalink to this definition">¶</a></dt>
<dd><p>Utilitário. Cria índices relacionados à integração.</p>
<p>São criados índices para desempenho nas consultas.
Alguns índices únicos também são criados, estes para evitar importação
duplicada do mesmo registro.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.carga.dados_carga_grava_fsfiles">
<code class="descclassname">virasana.virasana.integracao.carga.</code><code class="descname">dados_carga_grava_fsfiles</code><span class="sig-paren">(</span><em>db</em>, <em>batch_size=1000</em>, <em>data_inicio=datetime.datetime(1900</em>, <em>1</em>, <em>1</em>, <em>0</em>, <em>0)</em>, <em>days=4</em>, <em>update=True</em>, <em>force_update=False</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao/carga.html#dados_carga_grava_fsfiles"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.carga.dados_carga_grava_fsfiles" title="Permalink to this definition">¶</a></dt>
<dd><p>Busca por registros no GridFS sem info do CARGA.</p>
<p>Busca por registros no fs.files (GridFS - imagens) que não tenham metadata
importada do sistema CARGA. Itera estes registros, consultando a
busca_info_container para ver se retorna informações do CARGA. Encontrando
estas informações, grava no campo metadata.carga do fs.files</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><p class="first">db: conexão com o banco de dados selecionado.</p>
<p>batch_size: número de registros a consultar/atualizar por chamada</p>
<p>data_inicio: filtra por data de escaneamento maior que a informada</p>
<p>days: número de dias a aceitar de diferença</p>
<p>update: Caso seja setado como False, apenas faz consulta, sem
atualizar metadata da collection fs.files</p>
<p class="last">force_update: Marcar “NA” - not available se não encontrar dados do
CARGA. Usar com consciência/cuidado.</p>
</dd>
<dt>Returns:</dt>
<dd>Número de registros encontrados</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.carga.mongo_find_in">
<code class="descclassname">virasana.virasana.integracao.carga.</code><code class="descname">mongo_find_in</code><span class="sig-paren">(</span><em>db</em>, <em>collection: str</em>, <em>field: str</em>, <em>in_set</em>, <em>set_field: str = None</em><span class="sig-paren">)</span> &#x2192; typing.Tuple[list, set]<a class="reference internal" href="_modules/virasana/virasana/integracao/carga.html#mongo_find_in"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.carga.mongo_find_in" title="Permalink to this definition">¶</a></dt>
<dd><p>Realiza um find $in in_set no db.collection.</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><p class="first">db: conexão ao MongoDB com banco de dados selecionado “setted”</p>
<p>collection: nome da coleção mongo para aplicar a “query”</p>
<p>field: campo para aplicar a “filter by”</p>
<p>in_set: lista ou conjunto de valores a passar para o operador “$in”</p>
<p class="last">result_field: campo para obter valores únicos (opcional)</p>
</dd>
<dt>Returns:</dt>
<dd>Dicionário de resultados, formatado key:value (Somente campos não nulos)
Conjuntos de set_field</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.integracao.carga.nlinhas_zip_dir">
<code class="descclassname">virasana.virasana.integracao.carga.</code><code class="descname">nlinhas_zip_dir</code><span class="sig-paren">(</span><em>path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/integracao/carga.html#nlinhas_zip_dir"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.integracao.carga.nlinhas_zip_dir" title="Permalink to this definition">¶</a></dt>
<dd><p>Retorna o número de linhas de um conjunto de extrações.</p>
<p>Dado um diretório(path) procura extrações do Siscomex CARGA, abre seus zip,
abre o arquivo de cada zip e conta as linhas.</p>
<p>Para AUDITORIA após um arquivamento da base CARGA confirmar se número de
registros no arquivo (MongoDB) é igual a número original de linhas.</p>
<dl class="docutils">
<dt>Args:</dt>
<dd>path: caminho do(s) arquivo(s) de extração(ões)</dd>
<dt>Returns:</dt>
<dd>Número de conhecimentos</dd>
<dt>Comparar com:</dt>
<dd><dl class="first last docutils">
<dt>db[‘fs.files’].find({‘metadata.carga.atracacao.dataatracacao’:</dt>
<dd>{$gt: date, $lt: date}}).count()</dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
</div>
<div class="section" id="workers">
<h2><a class="toc-backref" href="#id7">Workers</a><a class="headerlink" href="#workers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="module-virasana.virasana.workers.dir_monitor">
<span id="dir-monitor"></span><h3><a class="toc-backref" href="#id8">dir_monitor</a><a class="headerlink" href="#module-virasana.virasana.workers.dir_monitor" title="Permalink to this headline">¶</a></h3>
<p>Monitora um diretório e envia arquivos BSON nele para o virasana.</p>
<p>USAGE
python dir_monitor.py</p>
<p>A cada intervalo de tempo configurado, lista os arquivos do diretório BSON_DIR
Se houverem arquivos, envia via POST para o endereco VIRASANA_URL</p>
<p>Pode ser importado e rodado em uma tarefa periódica (celery, cron, etc)</p>
<dl class="function">
<dt id="virasana.virasana.workers.dir_monitor.despacha">
<code class="descclassname">virasana.virasana.workers.dir_monitor.</code><code class="descname">despacha</code><span class="sig-paren">(</span><em>filename</em>, <em>target='http://localhost:5001/api/uploadbson'</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/workers/dir_monitor.html#despacha"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.workers.dir_monitor.despacha" title="Permalink to this definition">¶</a></dt>
<dd><p>Envia por HTTP POST o arquivo especificado.</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><p class="first">file: caminho completo do arquivo a enviar</p>
<p class="last">target: URL do Servidor e API destino</p>
</dd>
<dt>Returns:</dt>
<dd>(Erro, Resposta)
(True, None) se tudo correr bem
(False, response) se ocorrer erro</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.workers.dir_monitor.despacha_dir">
<code class="descclassname">virasana.virasana.workers.dir_monitor.</code><code class="descname">despacha_dir</code><span class="sig-paren">(</span><em>dir='P:SISTEMAS\\roteiros\\BSON_IVAN'</em>, <em>target='http://localhost:5001/api/uploadbson'</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/workers/dir_monitor.html#despacha_dir"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.workers.dir_monitor.despacha_dir" title="Permalink to this definition">¶</a></dt>
<dd><p>Envia por HTTP POST todos os arquivos do diretório.</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><p class="first">dir: caminho completo do diretório a pesquisar</p>
<p class="last">target: URL do Servidor e API destino</p>
</dd>
<dt>Returns:</dt>
<dd>Lista de erros</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.workers.dir_monitor.espera_resposta">
<code class="descclassname">virasana.virasana.workers.dir_monitor.</code><code class="descname">espera_resposta</code><span class="sig-paren">(</span><em>api_url</em>, <em>bson_file</em>, <em>sleep_time=10</em>, <em>timeout=180</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/workers/dir_monitor.html#espera_resposta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.workers.dir_monitor.espera_resposta" title="Permalink to this definition">¶</a></dt>
<dd><p>Espera resposta da task.</p>
<p>Espera resposta da task que efetivamente carregará o arquivo no
Banco de Dados do Servidor.
Recebendo uma resposta positiva, exclui arquivo enviado do disco.
Recebendo uma resposta negativa, grava no logger.</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><p class="first">api_url: endereço para acesso aos dados da task</p>
<p>bson_file: caminho completo do arquivo original que foi enviado</p>
<p>sleep_time: tempo entre requisições ao Servidor em segundos</p>
<p class="last">timeout: tempo total para aguardar resposta, em segundos</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-virasana.virasana.workers.tasks">
<span id="tasks"></span><h3><a class="toc-backref" href="#id9">tasks</a><a class="headerlink" href="#module-virasana.virasana.workers.tasks" title="Permalink to this headline">¶</a></h3>
<p>Definição dos códigos que serão rodados pelo Celery.</p>
<p>Background tasks do sistema AJNA-virasana
Gerenciados por celery.sh
Aqui ficam as rotinas que serão chamadas periodicamente e
aquelas que rodam tarefas custosas/demoradas em background.</p>
<dl class="function">
<dt id="virasana.virasana.workers.tasks.setup_periodic_tasks">
<code class="descclassname">virasana.virasana.workers.tasks.</code><code class="descname">setup_periodic_tasks</code><span class="sig-paren">(</span><em>sender</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/virasana/virasana/workers/tasks.html#setup_periodic_tasks"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.workers.tasks.setup_periodic_tasks" title="Permalink to this definition">¶</a></dt>
<dd><p>Agenda tarefas que serão executadas com frequência fixa.</p>
</dd></dl>

<dl class="function">
<dt id="virasana.virasana.workers.tasks.trata_bson">
<code class="descclassname">virasana.virasana.workers.tasks.</code><code class="descname">trata_bson</code><span class="sig-paren">(</span><em>bson_file: str</em>, <em>db: pymongo.mongo_client.MongoClient</em><span class="sig-paren">)</span> &#x2192; list<a class="reference internal" href="_modules/virasana/virasana/workers/tasks.html#trata_bson"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#virasana.virasana.workers.tasks.trata_bson" title="Permalink to this definition">¶</a></dt>
<dd><p>Recebe o nome de um arquivo bson e o insere no MongoDB.</p>
</dd></dl>

</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="padma.html" class="btn btn-neutral float-right" title="PADMA" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="bhadrasana.html" class="btn btn-neutral" title="BHADRASANA" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, RFB.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1a',
            LANGUAGE:'pt-BR',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>